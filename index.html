<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historical File Import Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
            padding: 20px;
            color: #e4e4e7;
        }

        .container {
            max-width: 1500px;
            margin: 0 auto;
            background: #1e1e2e;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.4), 0 0 80px rgba(99, 102, 241, 0.1);
            overflow: hidden;
            border: 1px solid #2d2d3d;
        }

        .header {
            background: linear-gradient(135deg, #1a1a2e 0%, #0f3460 100%);
            color: #e4e4e7;
            padding: 30px;
            text-align: center;
            border-bottom: 1px solid #3d3d5c;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
            color: #f4f4f5;
            text-shadow: 0 0 20px rgba(99, 102, 241, 0.5);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.8;
            color: #a1a1aa;
        }

        .content {
            padding: 40px;
            background: #1e1e2e;
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border: none;
            padding: 5px 12px;
            border-radius: 40px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 4px;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(99, 102, 241, 0.4);
        }

        .csv-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .csv-btn:hover {
            box-shadow: 0 10px 20px rgba(16, 185, 129, 0.4);
        }

        .txt-btn {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .txt-btn:hover {
            box-shadow: 0 10px 20px rgba(245, 158, 11, 0.4);
        }

        .xlsx-btn {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }

        .xlsx-btn:hover {
            box-shadow: 0 10px 20px rgba(59, 130, 246, 0.4);
        }

        .file-type-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-right: 10px;
        }

        .csv-indicator {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .txt-indicator {
            background: linear-gradient(135deg, #f97316 0%, #ec4899 100%);
            color: white;
        }

        .xlsx-indicator {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }

        /* Header Comparison Section Styles */
        .header-comparison-section {
            background: #252536;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px solid #3d3d5c;
            overflow: hidden;
        }

        .compare-section-header {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px 30px;
            cursor: pointer;
            transition: background 0.2s ease;
            user-select: none;
            position: relative;
        }

        .compare-section-header:hover {
            background: #2a2a4a;
        }

        .compare-section-header h3 {
            color: #e4e4e7;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2rem;
            text-align: center;
        }

        .compare-section-toggle {
            color: #71717a;
            font-size: 1rem;
            transition: transform 0.3s ease;
            position: absolute;
            right: 30px;
        }

        .compare-section-header.expanded .compare-section-toggle {
            transform: rotate(180deg);
        }

        .compare-section-body {
            padding: 0 30px 30px 30px;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header-row-input-group {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .header-row-input-group label {
            color: #e4e4e7;
            font-weight: 500;
        }

        .header-row-input-group input[type="number"] {
            width: 80px;
            padding: 10px 12px;
            border: 2px solid #3d3d5c;
            border-radius: 8px;
            font-size: 1rem;
            background: #1a1a2e;
            color: #e4e4e7;
            transition: border-color 0.3s ease;
        }

        .header-row-input-group input[type="number"]:focus {
            outline: none;
            border-color: #6366f1;
        }

        .compare-upload-zone {
            background: #1a1a2e;
            border: 2px dashed #4d4d6d;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            transition: all 0.3s ease;
            margin-bottom: 12px;
        }

        .compare-upload-zone:hover {
            border-color: #6366f1;
            background: #22223a;
        }

        .compare-upload-zone.dragover {
            border-color: #818cf8;
            background: #2d2d4d;
            transform: scale(1.01);
        }

        .compare-upload-zone p {
            color: #a1a1aa;
            margin-bottom: 6px;
            font-size: 0.8rem;
        }

        .compare-upload-buttons {
            display: flex;
            gap: 6px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .compare-file-list {
            margin-top: 20px;
        }

        .compare-file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #1a1a2e;
            border: 1px solid #3d3d5c;
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 10px;
            transition: all 0.2s ease;
        }

        .compare-file-item:hover {
            border-color: #4d4d6d;
        }

        .compare-file-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .compare-file-name {
            color: #e4e4e7;
            font-weight: 500;
        }

        .compare-file-size {
            color: #71717a;
            font-size: 0.85rem;
        }

        .compare-file-remove {
            background: transparent;
            border: none;
            color: #71717a;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .compare-file-remove:hover {
            color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }

        .compare-btn {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .compare-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.4);
        }

        .compare-btn:disabled {
            background: #3d3d5c;
            cursor: not-allowed;
            color: #71717a;
        }

        .compare-results {
            margin-top: 25px;
            display: none;
        }

        .compare-results.show {
            display: block;
        }

        .compare-results h4 {
            color: #e4e4e7;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #3d3d5c;
        }

        .compare-summary {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .compare-summary-card {
            background: #1a1a2e;
            border: 1px solid #3d3d5c;
            border-radius: 10px;
            padding: 15px 20px;
            text-align: center;
            min-width: 120px;
        }

        .compare-summary-card.success {
            border-color: #10b981;
        }

        .compare-summary-card.error {
            border-color: #ef4444;
        }

        .compare-summary-number {
            font-size: 1.8rem;
            font-weight: bold;
            color: #818cf8;
        }

        .compare-summary-card.success .compare-summary-number {
            color: #10b981;
        }

        .compare-summary-card.error .compare-summary-number {
            color: #ef4444;
        }

        .compare-summary-label {
            color: #a1a1aa;
            font-size: 0.85rem;
            margin-top: 5px;
        }

        .compare-status-message {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .compare-status-message.success {
            background: rgba(16, 185, 129, 0.15);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: #34d399;
        }

        .compare-status-message.error {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #f87171;
        }

        .compare-status-message.warning {
            background: rgba(245, 158, 11, 0.15);
            border: 1px solid rgba(245, 158, 11, 0.3);
            color: #fbbf24;
        }

        .compare-file-result {
            background: #1a1a2e;
            border: 1px solid #3d3d5c;
            border-radius: 10px;
            margin-bottom: 15px;
            overflow: hidden;
        }

        .compare-file-result.match {
            border-left: 4px solid #10b981;
        }

        .compare-file-result.mismatch {
            border-left: 4px solid #ef4444;
        }

        .compare-file-result.reference {
            border-left: 4px solid #6366f1;
        }

        .compare-file-result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: #22223a;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .compare-file-result-header:hover {
            background: #2a2a4a;
        }

        .compare-file-result-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .compare-file-result-title span {
            color: #e4e4e7;
            font-weight: 500;
        }

        .compare-file-status-badge {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .compare-file-status-badge.match {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            color: white;
        }

        .compare-file-status-badge.mismatch {
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
            color: white;
        }

        .compare-file-status-badge.reference {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
        }

        .compare-file-result-body {
            padding: 15px;
            display: none;
        }

        .compare-file-result-body.show {
            display: block;
        }

        .compare-headers-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .compare-header-tag {
            background: #3d3d5c;
            padding: 5px 10px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            color: #a5b4fc;
        }

        .compare-header-tag.missing {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .compare-header-tag.extra {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .compare-mismatch-details {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .compare-mismatch-details h5 {
            color: #f87171;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }

        .compare-xlsx-download {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
            padding: 10px;
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 8px;
        }

        .compare-xlsx-download span {
            color: #60a5fa;
            font-size: 0.9rem;
        }

        .compare-xlsx-download-btn {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border: none;
            padding: 6px 15px;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .compare-xlsx-download-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .compare-clear-btn {
            background: transparent;
            border: 1px solid #4d4d6d;
            color: #a1a1aa;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-left: 10px;
        }

        .compare-clear-btn:hover {
            border-color: #ef4444;
            color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }

        .bulk-convert-container {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 10px;
            padding: 15px 20px;
            margin: 20px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
        }

        .bulk-convert-info {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #60a5fa;
            font-weight: 500;
        }

        .bulk-convert-btn {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .bulk-convert-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }

        .bulk-convert-btn:disabled {
            background: #3d3d5c;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .expand-icon {
            color: #71717a;
            font-size: 0.9rem;
            transition: transform 0.2s ease;
        }

        .compare-file-result-header.expanded .expand-icon {
            transform: rotate(180deg);
        }

        /* ============================================
           CHANNEL IDENTIFIER SECTION STYLES
           ============================================ */
        .channel-identifier-section {
            background: #252536;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px solid #3d3d5c;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        /* Full-width mode when channel section is expanded */
        body.channel-section-expanded {
            overflow: hidden;
        }

        body.channel-section-expanded .channel-identifier-section {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1000;
            margin: 0;
            border-radius: 0;
            border: none;
            display: flex;
            flex-direction: column;
            background: #1e1e2e;
        }

        body.channel-section-expanded .channel-section-body {
            flex: 1;
            display: flex !important;
            flex-direction: column;
            overflow: hidden;
            padding: 15px;
        }

        body.channel-section-expanded .channel-identifier-layout {
            flex: 1;
            height: auto !important;
            min-height: 0;
        }

        body.channel-section-expanded .channel-section-header {
            border-radius: 0;
            flex-shrink: 0;
        }

        body.channel-section-expanded .channel-upload-row {
            flex-shrink: 0;
        }

        body.channel-section-expanded .pdf-panel,
        body.channel-section-expanded .chart-panel {
            height: 100% !important;
        }

        body.channel-section-expanded .channel-section-body > p {
            display: none;
        }

        /* Hide upload row when in full-width mode and layout is visible */
        body.channel-section-expanded .channel-upload-row.hidden-in-fullwidth {
            display: none;
        }

        .channel-section-header {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px 30px;
            cursor: pointer;
            transition: background 0.2s ease;
            user-select: none;
            position: relative;
            background: linear-gradient(135deg, #252536 0%, #1a1a2e 100%);
        }

        .channel-section-header:hover {
            background: linear-gradient(135deg, #2a2a4a 0%, #1e1e3e 100%);
        }

        .channel-section-header h3 {
            color: #e4e4e7;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2rem;
            text-align: center;
        }

        .channel-section-toggle {
            color: #71717a;
            font-size: 1rem;
            transition: transform 0.3s ease;
            position: absolute;
            right: 30px;
        }

        .channel-section-header.expanded .channel-section-toggle {
            transform: rotate(180deg);
        }

        .channel-section-body {
            padding: 0 30px 30px 30px;
            animation: slideDown 0.3s ease;
        }

        /* PDF Panel */
        .pdf-panel {
            background: #1a1a2e;
            border: 1px solid #3d3d5c;
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .pdf-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #252536;
            border-bottom: 1px solid #3d3d5c;
        }

        .pdf-panel-title {
            color: #e4e4e7;
            font-size: 1rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pdf-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .pdf-zoom-btn {
            background: #3d3d5c;
            color: #e4e4e7;
            border: 1px solid #4d4d6d;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pdf-zoom-btn:hover {
            background: #4d4d6d;
            border-color: #6366f1;
        }

        .pdf-zoom-level {
            color: #a1a1aa;
            font-size: 0.85rem;
            min-width: 50px;
            text-align: center;
        }

        /* PDF Zoom Slider */
        .pdf-zoom-slider-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 8px;
            padding-left: 8px;
            border-left: 1px solid #3d3d5c;
        }

        .pdf-zoom-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100px;
            height: 6px;
            background: linear-gradient(90deg, #3d3d5c 0%, #4d4d6d 100%);
            border-radius: 3px;
            outline: none;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .pdf-zoom-slider:hover {
            background: linear-gradient(90deg, #4d4d6d 0%, #6366f1 100%);
        }

        .pdf-zoom-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(99, 102, 241, 0.4);
            transition: all 0.2s ease;
        }

        .pdf-zoom-slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 3px 10px rgba(99, 102, 241, 0.6);
        }

        .pdf-zoom-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(99, 102, 241, 0.4);
            transition: all 0.2s ease;
        }

        .pdf-zoom-slider::-moz-range-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 3px 10px rgba(99, 102, 241, 0.6);
        }

        .pdf-zoom-slider::-moz-range-track {
            background: transparent;
        }

        .pdf-zoom-min-max {
            color: #71717a;
            font-size: 0.7rem;
        }

        .pdf-viewer-container {
            flex: 1;
            overflow: auto;
            max-height: 600px;
            padding: 15px;
            background: #141420;
        }

        .pdf-page-canvas {
            display: block;
            margin: 0 auto 15px auto;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            max-width: none;
        }

        .pdf-file-info {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            background: #252536;
            border-top: 1px solid #3d3d5c;
        }

        .pdf-file-name {
            color: #e4e4e7;
            font-size: 0.85rem;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .pdf-clear-btn {
            background: #3d3d5c;
            color: #f87171;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .pdf-clear-btn:hover {
            background: rgba(239, 68, 68, 0.2);
        }

        .pdf-page-indicator {
            color: #71717a;
            font-size: 0.8rem;
            text-align: center;
            margin-top: 5px;
        }

        /* Chart Panel */
        .chart-panel {
            background: #1a1a2e;
            border: 1px solid #3d3d5c;
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .chart-panel-header {
            padding: 15px;
            background: #252536;
            border-bottom: 1px solid #3d3d5c;
        }

        .chart-panel-title {
            color: #e4e4e7;
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .csv-upload-mini {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .csv-file-badge {
            background: #252536;
            color: #10b981;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 6px;
            border: 1px solid #3d3d5c;
        }

        .csv-file-badge .csv-clear {
            color: #f87171;
            cursor: pointer;
            font-size: 1rem;
            line-height: 1;
        }

        .csv-file-badge .csv-clear:hover {
            color: #ef4444;
        }

        .download-csv-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 10px;
            font-weight: 600;
        }

        .download-csv-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        /* Header Row Selector */
        .header-row-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
            background: #252536;
            border-bottom: 1px solid #3d3d5c;
            flex-wrap: wrap;
        }

        .header-row-selector label {
            color: #e4e4e7;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .header-row-selector input[type="number"] {
            width: 70px;
            padding: 6px 10px;
            border: 1px solid #3d3d5c;
            border-radius: 6px;
            font-size: 0.85rem;
            background: #1a1a2e;
            color: #e4e4e7;
            transition: border-color 0.2s ease;
        }

        .header-row-selector input[type="number"]:focus {
            outline: none;
            border-color: #6366f1;
        }

        .header-row-hint {
            color: #71717a;
            font-size: 0.75rem;
            flex: 1;
        }

        .header-row-apply-btn {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border: none;
            padding: 6px 14px;
            border-radius: 15px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .header-row-apply-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(99, 102, 241, 0.3);
        }

        .header-row-status {
            color: #a1a1aa;
            font-size: 0.75rem;
            margin-left: auto;
            white-space: nowrap;
        }

        .header-row-status.error {
            color: #f87171;
        }

        /* Column Selector */
        .column-selector-container {
            padding: 15px;
            border-bottom: none;
            height: 200px;
            min-height: 80px;
            overflow-y: auto;
        }

        .column-selector-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .column-selector-title {
            color: #a1a1aa;
            font-size: 0.85rem;
        }

        .column-selector-actions {
            display: flex;
            gap: 8px;
        }

        .column-action-btn {
            background: transparent;
            color: #818cf8;
            border: 1px solid #3d3d5c;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .column-action-btn:hover {
            background: rgba(99, 102, 241, 0.1);
            border-color: #6366f1;
        }

        /* Column filters row (search + avg range) */
        .column-filters-row {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        .column-avg-filter-container {
            flex-shrink: 0;
        }

        .column-avg-filter-wrapper {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }

        .column-avg-filter-label {
            color: #a1a1aa;
            font-size: 0.85rem;
            white-space: nowrap;
        }

        .column-avg-input {
            width: 72px;
            padding: 8px 10px;
            background: #1e1e2e;
            border: 1px solid #3d3d5c;
            border-radius: 6px;
            color: #e4e4e7;
            font-size: 0.85rem;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .column-avg-input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }

        .column-avg-input::placeholder {
            color: #71717a;
        }

        .column-avg-sep {
            color: #71717a;
            font-size: 0.8rem;
        }

        .column-avg-clear {
            display: none;
            background: none;
            border: none;
            color: #71717a;
            cursor: pointer;
            padding: 2px 6px;
            font-size: 1rem;
            line-height: 1;
            border-radius: 4px;
        }

        .column-avg-clear:hover {
            color: #e4e4e7;
            background: rgba(255, 255, 255, 0.1);
        }

        .column-avg-clear.visible {
            display: inline-block;
        }

        /* Column Search Input */
        .column-search-container {
            margin-bottom: 0;
        }

        .column-search-input {
            width: 100%;
            padding: 8px 12px;
            padding-left: 32px;
            background: #1e1e2e;
            border: 1px solid #3d3d5c;
            border-radius: 6px;
            color: #e4e4e7;
            font-size: 0.85rem;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .column-search-input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }

        .column-search-input::placeholder {
            color: #71717a;
        }

        .column-search-wrapper {
            position: relative;
            max-width: 280px;
        }

        .column-search-icon {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #71717a;
            font-size: 0.85rem;
            pointer-events: none;
        }

        .column-search-clear {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #71717a;
            cursor: pointer;
            padding: 2px 6px;
            font-size: 1rem;
            line-height: 1;
            border-radius: 4px;
            display: none;
        }

        .column-search-clear:hover {
            color: #e4e4e7;
            background: rgba(255, 255, 255, 0.1);
        }

        .column-search-clear.visible {
            display: block;
        }

        .column-checkbox-item.hidden {
            display: none !important;
        }

        .column-search-results {
            font-size: 0.75rem;
            color: #71717a;
            margin-top: 6px;
            text-align: right;
        }

        .column-checkboxes {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .column-checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #252536;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }

        .column-checkbox-item:hover {
            background: #2a2a4a;
            border-color: #3d3d5c;
        }

        .column-checkbox-item.selected {
            border-color: #6366f1;
            background: rgba(99, 102, 241, 0.1);
        }

        .column-checkbox-item input[type="checkbox"] {
            accent-color: #6366f1;
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .column-checkbox-label {
            color: #e4e4e7;
            font-size: 0.8rem;
            word-break: break-word;
        }

        .column-color-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .column-checkbox-item.non-numeric {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .column-checkbox-item.non-numeric .column-checkbox-label {
            color: #71717a;
        }

        .non-numeric-badge {
            background: #3d3d5c;
            color: #71717a;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.65rem;
            text-transform: uppercase;
            flex-shrink: 0;
        }

        .column-average {
            color: #10b981;
            font-size: 0.7rem;
            margin-left: 8px;
            flex-shrink: 0;
            font-family: 'Consolas', 'Monaco', monospace;
            background: rgba(16, 185, 129, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
        }

        .column-checkbox-item.non-numeric .column-average {
            display: none;
        }

        /* Values â‰¤ 0 Collapsible Section */
        .zero-columns-section {
            margin-top: 12px;
            border: 1px solid #3d3d5c;
            border-radius: 8px;
            overflow: hidden;
        }

        .zero-columns-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 14px;
            background: #1e1e2e;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s ease;
        }

        .zero-columns-header:hover {
            background: #252536;
        }

        .zero-columns-title {
            color: #71717a;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .zero-columns-count {
            background: #3d3d5c;
            color: #a1a1aa;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .zero-columns-toggle {
            color: #71717a;
            font-size: 0.8rem;
            transition: transform 0.3s ease;
        }

        .zero-columns-header.expanded .zero-columns-toggle {
            transform: rotate(180deg);
        }

        .zero-columns-body {
            display: none;
            padding: 10px;
            background: #1a1a2e;
        }

        .zero-columns-body.expanded {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .zero-columns-hint {
            width: 100%;
            color: #52525b;
            font-size: 0.7rem;
            margin-bottom: 6px;
            font-style: italic;
        }

        /* Chart Legend with Averages */
        .chart-legend-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 10px 15px;
            background: #1e1e2e;
            border-bottom: 1px solid #3d3d5c;
            max-height: 120px;
            overflow-y: auto;
        }

        .chart-legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            background: #252536;
            border-radius: 4px;
            font-size: 0.75rem;
        }

        .chart-legend-color {
            width: 12px;
            height: 3px;
            border-radius: 2px;
        }

        .chart-legend-name {
            color: #e4e4e7;
            word-break: break-word;
        }

        .chart-legend-avg {
            color: #10b981;
            font-family: 'Consolas', 'Monaco', monospace;
        }

        /* Chart axis scale toolbar (inside popup) */
        .chart-axis-scale-toolbar {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px 16px;
            margin: 0;
            padding: 0;
        }

        .chart-axis-scale-label {
            color: #a1a1aa;
            font-size: 0.9rem;
        }

        .chart-axis-scale-toolbar label {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: #a1a1aa;
            font-size: 0.875rem;
        }

        .chart-axis-scale-toolbar input[type="number"] {
            width: 90px;
            padding: 6px 10px;
            background: #252536;
            border: 1px solid #3d3d5c;
            border-radius: 6px;
            color: #e4e4e7;
            font-size: 0.875rem;
        }

        .chart-axis-scale-toolbar input[type="number"]:focus {
            outline: none;
            border-color: #6366f1;
        }

        .chart-scale-apply-btn {
            padding: 6px 14px;
            background: #6366f1;
            color: #fff;
            border: none;
            border-radius: 6px;
            font-size: 0.875rem;
            cursor: pointer;
        }

        .chart-scale-apply-btn:hover {
            background: #4f46e5;
        }

        .chart-scale-reset-btn {
            padding: 6px 14px;
            background: transparent;
            color: #a1a1aa;
            border: 1px solid #3d3d5c;
            border-radius: 6px;
            font-size: 0.875rem;
            cursor: pointer;
        }

        .chart-scale-reset-btn:hover {
            color: #e4e4e7;
            border-color: #71717a;
        }

        .chart-axis-scale-hint {
            display: none;
        }

        /* Y-axis scale popup (shown only when Y-axis is clicked) */
        .chart-scale-popup {
            display: none;
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 20;
            background: #1e1e2e;
            border: 1px solid #3d3d5c;
            border-radius: 10px;
            padding: 12px 32px 12px 14px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .chart-scale-popup.show {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px 16px;
        }

        .chart-scale-popup .chart-axis-scale-toolbar {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px 16px;
            margin: 0;
            padding: 0;
            background: transparent;
            border: none;
        }

        .chart-scale-popup-close {
            position: absolute;
            top: 6px;
            right: 8px;
            background: transparent;
            border: none;
            color: #71717a;
            font-size: 1.2rem;
            cursor: pointer;
            line-height: 1;
            padding: 0;
        }

        .chart-scale-popup-close:hover {
            color: #e4e4e7;
        }

        /* Comparison Chart */
        .comparison-chart-container {
            position: relative;
            flex: 1;
            padding: 15px;
            min-height: 450px;
        }

        .comparison-chart-placeholder {
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #71717a;
            text-align: center;
        }

        .comparison-chart-placeholder-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .no-columns-message {
            color: #a1a1aa;
            font-size: 0.9rem;
            text-align: center;
            padding: 20px;
        }

        /* Upload Sections in Channel Identifier */
        .channel-upload-row {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }

        @media (max-width: 768px) {
            .channel-upload-row {
                flex-direction: column;
            }
        }

        .channel-upload-box {
            flex: 1;
            background: #1a1a2e;
            border: 2px dashed #4d4d6d;
            border-radius: 8px;
            padding: 12px 16px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .channel-upload-box:hover {
            border-color: #6366f1;
            background: #22223a;
        }

        .channel-upload-box.dragover {
            border-color: #818cf8;
            background: #2d2d4d;
            transform: scale(1.01);
        }

        .channel-upload-box.has-file {
            border-style: solid;
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.05);
        }

        .channel-upload-box-icon {
            font-size: 1.5rem;
            margin-bottom: 4px;
        }

        .channel-upload-box-title {
            color: #e4e4e7;
            font-size: 0.875rem;
            margin-bottom: 2px;
        }

        .channel-upload-box-subtitle {
            color: #71717a;
            font-size: 0.7rem;
        }

        .channel-upload-box-file {
            color: #10b981;
            font-size: 0.75rem;
            margin-top: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        /* Resizable Panel Styles */
        .channel-identifier-layout {
            display: flex !important;
            flex-direction: row;
            gap: 0;
            margin-top: 20px;
            height: 900px;
        }

        .channel-identifier-layout .pdf-panel {
            flex: 0 0 auto;
            width: 50%;
            min-width: 200px;
            max-width: calc(100% - 220px);
            height: 100%;
            overflow: hidden;
        }

        .channel-identifier-layout .chart-panel {
            flex: 1;
            min-width: 200px;
            height: 100%;
            overflow: hidden;
        }

        .panel-resizer {
            width: 8px;
            background: linear-gradient(180deg, #3d3d5c 0%, #252536 50%, #3d3d5c 100%);
            cursor: col-resize;
            position: relative;
            flex-shrink: 0;
            transition: background 0.2s ease;
            z-index: 10;
        }

        .panel-resizer:hover,
        .panel-resizer.dragging {
            background: linear-gradient(180deg, #6366f1 0%, #8b5cf6 50%, #6366f1 100%);
        }

        .panel-resizer::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 4px;
            height: 40px;
            background: linear-gradient(180deg, 
                transparent 0%, 
                #71717a 20%, 
                #a1a1aa 50%, 
                #71717a 80%, 
                transparent 100%);
            border-radius: 2px;
            opacity: 0.6;
            transition: opacity 0.2s ease;
        }

        .panel-resizer:hover::before,
        .panel-resizer.dragging::before {
            opacity: 1;
            background: linear-gradient(180deg, 
                transparent 0%, 
                #e4e4e7 20%, 
                #ffffff 50%, 
                #e4e4e7 80%, 
                transparent 100%);
        }

        /* Update PDF viewer container for resizable layout */
        .channel-identifier-layout .pdf-viewer-container {
            flex: 1;
            overflow: auto;
            max-height: none;
            min-height: 0;
        }

        /* Allow PDF controls to wrap on narrow panels */
        .channel-identifier-layout .pdf-panel-header {
            flex-wrap: wrap;
            gap: 10px;
        }

        .channel-identifier-layout .pdf-controls {
            flex-wrap: wrap;
        }

        /* Update chart panel internals for scrolling */
        .channel-identifier-layout .chart-panel {
            display: flex;
            flex-direction: column;
        }

        .channel-identifier-layout .column-selector-container {
            flex-shrink: 0;
            max-height: none;
            height: 200px;
            min-height: 80px;
            overflow-y: auto;
        }

        /* Column Selector Vertical Resizer */
        .column-resizer {
            height: 8px;
            background: linear-gradient(90deg, #3d3d5c 0%, #252536 50%, #3d3d5c 100%);
            cursor: row-resize;
            position: relative;
            flex-shrink: 0;
            transition: background 0.2s ease;
            z-index: 10;
        }

        .column-resizer:hover,
        .column-resizer.dragging {
            background: linear-gradient(90deg, #6366f1 0%, #8b5cf6 50%, #6366f1 100%);
        }

        .channel-identifier-layout .comparison-chart-container {
            flex: 1;
            min-height: 400px;
            overflow: visible;
            padding-bottom: 30px;
        }

        /* Prevent text selection while dragging */
        body.resizing {
            user-select: none;
            cursor: col-resize !important;
        }

        body.resizing * {
            cursor: col-resize !important;
        }

        body.resizing-vertical {
            user-select: none;
            cursor: row-resize !important;
        }

        body.resizing-vertical * {
            cursor: row-resize !important;
        }

        @media (max-width: 1200px) {
            .channel-identifier-layout {
                flex-direction: column !important;
                height: auto;
            }

            .channel-identifier-layout .pdf-panel,
            .channel-identifier-layout .chart-panel {
                width: 100% !important;
                max-width: 100% !important;
                min-width: 100% !important;
                height: 650px;
            }

            .panel-resizer {
                display: none;
            }
        }
    </style>
    <!-- SheetJS library for Excel file processing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Chart.js library for column data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- PDF.js library for PDF rendering -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ“‚ Historical File Import Tool</h1>
            <p>Compare CSV/XLSX headers and identify channels from PDF vs CSV data Â· v4</p>
        </div>

        <div class="content">
            <!-- Header Comparison Section -->
            <div class="header-comparison-section">
                <div class="compare-section-header" id="compareSectionHeader" onclick="toggleCompareSection()">
                    <h3>Header Comparison for Historical Files</h3>
                    <span class="compare-section-toggle" id="compareSectionToggle">â–¼</span>
                </div>
                
                <div class="compare-section-body" id="compareSectionBody" style="display: none;">
                    <p style="color: #a1a1aa; margin-bottom: 20px;">Upload multiple CSV, TXT, or XLSX files to compare their headers. Headers must match exactly (spacing, characters, everything). You can bulk convert XLSX or TXT files to CSV while comparing.</p>
                    
                    <div class="header-row-input-group">
                        <label for="compareHeaderRow">Header Row Number:</label>
                        <input type="number" id="compareHeaderRow" min="1" value="1" placeholder="1">
                        <span style="color: #71717a; font-size: 0.85rem;">(Which row contains the column headers?)</span>
                    </div>
                    
                    <div class="compare-upload-zone" id="compareUploadZone">
                        <p>Drag and drop files here, or click to upload</p>
                        <div class="compare-upload-buttons">
                            <input type="file" id="compareFileInput" class="file-input" accept=".csv,.txt,.xlsx,.xls" multiple>
                            <button class="upload-btn csv-btn" onclick="document.getElementById('compareFileInput').click()">
                                ðŸ“ Upload CSV/TXT/XLSX Files
                            </button>
                        </div>
                    </div>
                    
                    <div class="compare-file-list" id="compareFileList">
                        <!-- Uploaded files will be listed here -->
                    </div>
                    
                    <!-- Bulk XLSX/TXT to CSV conversion -->
                    <div class="bulk-convert-container" id="bulkConvertContainer" style="display: none;">
                        <div class="bulk-convert-info">
                            <span id="bulkConvertFileCounts"><span class="xlsx-indicator file-type-badge">XLSX</span> <span id="xlsxFileCount">0</span> Â· <span class="txt-indicator file-type-badge">TXT</span> <span id="txtFileCount">0</span></span> file(s) to convert to CSV
                        </div>
                        <button class="bulk-convert-btn" id="bulkConvertBtn" onclick="bulkConvertToCsv()">
                            ðŸ“¥ Convert All to CSV & Download
                        </button>
                    </div>
                    
                    <div style="text-align: center;">
                        <button class="compare-btn" id="compareHeadersBtn" onclick="compareHeaders()" disabled>
                            ðŸ”„ Compare Headers
                        </button>
                        <button class="compare-clear-btn" id="compareClearBtn" onclick="clearCompareFiles()" style="display: none;">
                            âœ• Clear All
                        </button>
                    </div>
                    
                    <div class="compare-results" id="compareResults">
                        <h4>Comparison Results <span id="compareHeaderRowUsed" style="font-weight: normal; font-size: 0.9rem; color: #a1a1aa;"></span></h4>
                        <div id="compareSummary"></div>
                        <div id="compareStatusMessage"></div>
                        <div id="compareFileResults"></div>
                    </div>
                </div>
            </div>

            <!-- Channel Identifier Section - PDF vs CSV Comparison -->
            <div class="channel-identifier-section">
                <div class="channel-section-header" id="channelSectionHeader" onclick="toggleChannelSection()">
                    <h3>ðŸ“Š Channel Identifier - PDF vs CSV Comparison</h3>
                    <span class="channel-section-toggle" id="channelSectionToggle">â–¼</span>
                </div>
                
                <div class="channel-section-body" id="channelSectionBody" style="display: none;">
                    <p style="color: #a1a1aa; margin-bottom: 20px;">
                        Upload a PDF containing graphs and a CSV, TXT, or XLSX file with 1-second data to visually compare and identify which columns correspond to the graphs in the PDF. TXT and XLSX files will be automatically converted to CSV format.
                    </p>
                    
                    <!-- Upload Row -->
                    <div class="channel-upload-row">
                        <div class="channel-upload-box" id="pdfUploadBox" onclick="document.getElementById('channelPdfInput').click()">
                            <input type="file" id="channelPdfInput" class="file-input" accept=".pdf">
                            <div class="channel-upload-box-icon">ðŸ“„</div>
                            <div class="channel-upload-box-title">Upload PDF File</div>
                            <div class="channel-upload-box-subtitle">PDF with graphs to compare</div>
                            <div class="channel-upload-box-file" id="pdfFileName" style="display: none;">
                                <span>âœ“</span>
                                <span id="pdfFileNameText"></span>
                            </div>
                        </div>
                        
                        <div class="channel-upload-box" id="historicalFileUploadBox" onclick="document.getElementById('channelHistoricalFileInput').click()">
                            <input type="file" id="channelHistoricalFileInput" class="file-input" accept=".csv,.txt,.xlsx,.xls">
                            <div class="channel-upload-box-icon">ðŸ“ˆ</div>
                            <div class="channel-upload-box-title">Upload Historical File</div>
                            <div class="channel-upload-box-subtitle">CSV/TXT/XLSX with 1-second data</div>
                            <div class="channel-upload-box-file" id="historicalFileName" style="display: none;">
                                <span>âœ“</span>
                                <span id="historicalFileNameText"></span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Side-by-side Layout -->
                    <div class="channel-identifier-layout" id="channelIdentifierLayout" style="display: none;">
                        <!-- PDF Panel -->
                        <div class="pdf-panel">
                            <div class="pdf-panel-header">
                                <div class="pdf-panel-title">
                                    <span>ðŸ“„</span>
                                    <span>PDF Viewer</span>
                                </div>
                                <div class="pdf-controls">
                                    <button class="pdf-zoom-btn" id="pdfZoomOut" onclick="zoomPdf(-0.25)" title="Zoom Out">âˆ’</button>
                                    <span class="pdf-zoom-level" id="pdfZoomLevel">100%</span>
                                    <button class="pdf-zoom-btn" id="pdfZoomIn" onclick="zoomPdf(0.25)" title="Zoom In">+</button>
                                    <div class="pdf-zoom-slider-container">
                                        <span class="pdf-zoom-min-max">25%</span>
                                        <input type="range" class="pdf-zoom-slider" id="pdfZoomSlider" 
                                               min="25" max="300" value="100" step="5"
                                               oninput="zoomPdfToValue(this.value)" 
                                               title="Drag to zoom">
                                        <span class="pdf-zoom-min-max">300%</span>
                                    </div>
                                    <button class="pdf-zoom-btn" id="pdfFitWidth" onclick="fitPdfToWidth()" title="Fit to Width">â†”</button>
                                </div>
                            </div>
                            <div class="pdf-viewer-container" id="pdfViewerContainer">
                                <!-- PDF pages will be rendered here -->
                            </div>
                            <div class="pdf-file-info" id="pdfFileInfo">
                                <span class="pdf-file-name" id="pdfViewerFileName"></span>
                                <span class="pdf-page-indicator" id="pdfPageIndicator"></span>
                                <button class="pdf-clear-btn" onclick="clearPdfFile()">âœ• Clear</button>
                            </div>
                        </div>
                        
                        <!-- Panel Resizer -->
                        <div class="panel-resizer" id="panelResizer" title="Drag to resize panels"></div>
                        
                        <!-- Chart Panel -->
                        <div class="chart-panel">
                            <div class="chart-panel-header">
                                <div class="chart-panel-title">
                                    <span>ðŸ“ˆ</span>
                                    <span>CSV Data Viewer</span>
                                </div>
                                <div class="csv-upload-mini">
                                    <span class="csv-file-badge" id="csvFileBadge">
                                        <span id="csvBadgeFileName">No file loaded</span>
                                        <span class="csv-clear" onclick="clearCsvFile()" title="Clear CSV">Ã—</span>
                                    </span>
                                    <button id="downloadCsvBtn" class="download-csv-btn" onclick="downloadConvertedCsv()" style="display: none;" title="Download as CSV">
                                        ðŸ“¥ Download CSV
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Header Row Selector -->
                            <div class="header-row-selector">
                                <label for="channelHeaderRow">Header Row:</label>
                                <input type="number" id="channelHeaderRow" min="1" value="1" onkeypress="if(event.key==='Enter')reprocessCsvWithNewHeaderRow()">
                                <span class="header-row-hint">Which row contains column names?</span>
                                <button class="header-row-apply-btn" onclick="reprocessCsvWithNewHeaderRow()">Apply</button>
                                <span class="header-row-status" id="headerRowStatus"></span>
                            </div>
                            
                            <!-- Column Selector -->
                            <div class="column-selector-container" id="columnSelectorContainer">
                                <div class="column-selector-header">
                                    <span class="column-selector-title">Select columns to plot:</span>
                                    <div class="column-selector-actions">
                                        <button class="column-action-btn" onclick="selectAllColumns()">Select All</button>
                                        <button class="column-action-btn" onclick="clearAllColumns()">Clear All</button>
                                    </div>
                                </div>
                                <div class="column-filters-row">
                                    <div class="column-search-container">
                                        <div class="column-search-wrapper">
                                            <span class="column-search-icon">ðŸ”</span>
                                            <input type="text" class="column-search-input" id="columnSearchInput" placeholder="Search columns..." oninput="applyColumnFilters()">
                                            <button class="column-search-clear" id="columnSearchClear" onclick="clearColumnSearch()" title="Clear search">Ã—</button>
                                        </div>
                                        <div class="column-search-results" id="columnSearchResults"></div>
                                    </div>
                                    <div class="column-avg-filter-container">
                                        <div class="column-avg-filter-wrapper">
                                            <span class="column-avg-filter-label">Avg range:</span>
                                            <input type="number" class="column-avg-input" id="columnAvgMin" step="any" placeholder="Min" title="Minimum average value" oninput="applyColumnFilters()">
                                            <span class="column-avg-sep">to</span>
                                            <input type="number" class="column-avg-input" id="columnAvgMax" step="any" placeholder="Max" title="Maximum average value" oninput="applyColumnFilters()">
                                            <button type="button" class="column-avg-clear" id="columnAvgClear" onclick="clearAvgFilter()" title="Clear average filter">Ã—</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="column-checkboxes" id="columnCheckboxes">
                                    <div class="no-columns-message">Upload a CSV, TXT, or XLSX file to see available columns</div>
                                </div>
                            </div>
                            
                            <!-- Column Selector Resizer -->
                            <div class="column-resizer" id="columnResizer" title="Drag to resize column viewer"></div>
                            
                            <!-- Comparison Chart -->
                            <div class="comparison-chart-container">
                                <div id="comparisonChartScalePopup" class="chart-scale-popup">
                                    <button type="button" class="chart-scale-popup-close" onclick="closeComparisonChartScalePopup()" title="Close">Ã—</button>
                                    <div class="chart-axis-scale-toolbar comparison-chart-scale-toolbar" id="comparisonChartScaleToolbar">
                                        <span class="chart-axis-scale-label">Y-axis scale:</span>
                                        <label>Min <input type="number" id="comparisonChartYMin" step="any" placeholder="auto" title="Minimum value for Y axis"></label>
                                        <label>Max <input type="number" id="comparisonChartYMax" step="any" placeholder="auto" title="Maximum value for Y axis"></label>
                                        <button type="button" class="chart-scale-apply-btn" onclick="applyComparisonChartAxisScale()">Apply</button>
                                        <button type="button" class="chart-scale-reset-btn" onclick="resetComparisonChartAxisScale()">Reset to auto</button>
                                        <span class="chart-axis-scale-hint">Click the Y-axis on the chart to set scale</span>
                                    </div>
                                </div>
                                <div class="chart-legend-container" id="chartLegendContainer" style="display: none;"></div>
                                <canvas id="comparisonChart"></canvas>
                                <div class="comparison-chart-placeholder" id="comparisonChartPlaceholder">
                                    <div class="comparison-chart-placeholder-icon">ðŸ“Š</div>
                                    <div>Select columns from the CSV to plot them here</div>
                                    <div style="font-size: 0.8rem; margin-top: 5px;">Compare with the PDF graphs to identify channels</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // HEADER COMPARISON SECTION
        // ============================================
        
        // Store uploaded files for comparison
        let compareFiles = [];
        let compareFilesData = {};
        
        function toggleCompareSection() {
            const header = document.getElementById('compareSectionHeader');
            const body = document.getElementById('compareSectionBody');
            const isExpanded = header.classList.contains('expanded');
            
            if (isExpanded) {
                header.classList.remove('expanded');
                body.style.display = 'none';
            } else {
                header.classList.add('expanded');
                body.style.display = 'block';
            }
        }
        
        function initializeHeaderComparison() {
            const compareFileInput = document.getElementById('compareFileInput');
            const compareUploadZone = document.getElementById('compareUploadZone');
            
            compareFileInput.addEventListener('change', function(e) {
                handleCompareFiles(e.target.files);
                e.target.value = '';
            });
            
            compareUploadZone.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.classList.add('dragover');
            });
            
            compareUploadZone.addEventListener('dragleave', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.classList.remove('dragover');
            });
            
            compareUploadZone.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.classList.remove('dragover');
                handleCompareFiles(e.dataTransfer.files);
            });
        }
        
        function handleCompareFiles(files) {
            for (let file of files) {
                const ext = file.name.split('.').pop().toLowerCase();
                if (['csv', 'txt', 'xlsx', 'xls'].includes(ext)) {
                    if (!compareFiles.find(f => f.name === file.name && f.size === file.size)) {
                        compareFiles.push(file);
                    }
                }
            }
            updateCompareFileList();
        }
        
        function updateCompareFileList() {
            const fileList = document.getElementById('compareFileList');
            const compareBtn = document.getElementById('compareHeadersBtn');
            const clearBtn = document.getElementById('compareClearBtn');
            const bulkConvertContainer = document.getElementById('bulkConvertContainer');
            const xlsxFileCountSpan = document.getElementById('xlsxFileCount');
            
            if (compareFiles.length === 0) {
                fileList.innerHTML = '';
                compareBtn.disabled = true;
                clearBtn.style.display = 'none';
                bulkConvertContainer.style.display = 'none';
                return;
            }
            
            clearBtn.style.display = 'inline-block';
            compareBtn.disabled = compareFiles.length < 2;
            
            // Count XLSX and TXT files (convertible to CSV)
            const xlsxFiles = compareFiles.filter(f => {
                const ext = f.name.split('.').pop().toLowerCase();
                return ['xlsx', 'xls'].includes(ext);
            });
            const txtFiles = compareFiles.filter(f => {
                const ext = f.name.split('.').pop().toLowerCase();
                return ext === 'txt';
            });
            const txtFileCountSpan = document.getElementById('txtFileCount');
            
            if (xlsxFiles.length > 0 || txtFiles.length > 0) {
                bulkConvertContainer.style.display = 'flex';
                xlsxFileCountSpan.textContent = xlsxFiles.length;
                txtFileCountSpan.textContent = txtFiles.length;
            } else {
                bulkConvertContainer.style.display = 'none';
            }
            
            fileList.innerHTML = compareFiles.map((file, index) => {
                const ext = file.name.split('.').pop().toLowerCase();
                const badgeClass = ext === 'csv' ? 'csv-indicator' : (ext === 'txt' ? 'txt-indicator' : 'xlsx-indicator');
                return `
                    <div class="compare-file-item">
                        <div class="compare-file-info">
                            <span class="file-type-badge ${badgeClass}">${ext.toUpperCase()}</span>
                            <span class="compare-file-name">${file.name}</span>
                            <span class="compare-file-size">(${(file.size / 1024).toFixed(2)} KB)</span>
                        </div>
                        <button class="compare-file-remove" onclick="removeCompareFile(${index})" title="Remove file">âœ•</button>
                    </div>
                `;
            }).join('');
        }
        
        function removeCompareFile(index) {
            const fileName = compareFiles[index].name;
            compareFiles.splice(index, 1);
            delete compareFilesData[fileName];
            updateCompareFileList();
            
            if (compareFiles.length < 2) {
                document.getElementById('compareResults').classList.remove('show');
            }
        }
        
        function clearCompareFiles() {
            compareFiles = [];
            compareFilesData = {};
            updateCompareFileList();
            document.getElementById('compareResults').classList.remove('show');
        }
        
        async function bulkConvertToCsv() {
            const xlsxFiles = compareFiles.filter(f => {
                const ext = f.name.split('.').pop().toLowerCase();
                return ['xlsx', 'xls'].includes(ext);
            });
            const txtFiles = compareFiles.filter(f => {
                const ext = f.name.split('.').pop().toLowerCase();
                return ext === 'txt';
            });
            const convertibleFiles = [...xlsxFiles, ...txtFiles];
            
            if (convertibleFiles.length === 0) {
                alert('No XLSX or TXT files to convert.');
                return;
            }
            
            const bulkBtn = document.getElementById('bulkConvertBtn');
            bulkBtn.disabled = true;
            bulkBtn.textContent = 'â³ Converting...';
            
            try {
                for (let file of convertibleFiles) {
                    const ext = file.name.split('.').pop().toLowerCase();
                    if (['xlsx', 'xls'].includes(ext)) {
                        await convertAndDownloadXlsx(file);
                    } else if (ext === 'txt') {
                        await convertAndDownloadTxt(file);
                    }
                    await new Promise(resolve => setTimeout(resolve, 300));
                }
                
                bulkBtn.textContent = 'âœ… Downloaded!';
                setTimeout(() => {
                    bulkBtn.textContent = 'ðŸ“¥ Convert All to CSV & Download';
                    bulkBtn.disabled = false;
                }, 2000);
                
            } catch (error) {
                console.error('Error converting files:', error);
                alert('Error converting files: ' + error.message);
                bulkBtn.textContent = 'ðŸ“¥ Convert All to CSV & Download';
                bulkBtn.disabled = false;
            }
        }
        
        function convertAndDownloadTxt(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const content = e.target.result;
                        const csvContent = convertTxtToCsv(content, 'txt');
                        const downloadFileName = file.name.replace(/\.txt$/i, '.csv');
                        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                        const link = document.createElement('a');
                        if (link.download !== undefined) {
                            const url = URL.createObjectURL(blob);
                            link.setAttribute('href', url);
                            link.setAttribute('download', downloadFileName);
                            link.style.visibility = 'hidden';
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            URL.revokeObjectURL(url);
                        }
                        resolve();
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = () => reject(new Error('Failed to read file: ' + file.name));
                reader.readAsText(file);
            });
        }
        
        function convertAndDownloadXlsx(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const csvContent = XLSX.utils.sheet_to_csv(firstSheet);
                        
                        const downloadFileName = file.name.replace(/\.(xlsx|xls)$/i, '.csv');
                        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                        const link = document.createElement('a');
                        
                        if (link.download !== undefined) {
                            const url = URL.createObjectURL(blob);
                            link.setAttribute('href', url);
                            link.setAttribute('download', downloadFileName);
                            link.style.visibility = 'hidden';
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            URL.revokeObjectURL(url);
                        }
                        
                        resolve();
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = () => reject(new Error('Failed to read file: ' + file.name));
                reader.readAsArrayBuffer(file);
            });
        }
        
        async function compareHeaders() {
            if (compareFiles.length < 2) {
                alert('Please upload at least 2 files to compare.');
                return;
            }
            
            const headerRow = parseInt(document.getElementById('compareHeaderRow').value) || 1;
            compareFilesData = {};
            
            const compareBtn = document.getElementById('compareHeadersBtn');
            compareBtn.disabled = true;
            compareBtn.textContent = 'â³ Processing...';
            
            try {
                for (let file of compareFiles) {
                    const ext = file.name.split('.').pop().toLowerCase();
                    let headers = [];
                    let csvContent = null;
                    
                    if (ext === 'csv') {
                        const content = await readFileAsText(file);
                        headers = parseCompareHeaders(content, headerRow, 'csv');
                        csvContent = content;
                    } else if (ext === 'txt') {
                        const content = await readFileAsText(file);
                        csvContent = convertTxtToCsv(content, 'txt');
                        headers = parseCompareHeaders(csvContent, headerRow, 'csv');
                    } else if (['xlsx', 'xls'].includes(ext)) {
                        const result = await parseXlsxForCompare(file, headerRow);
                        headers = result.headers;
                        csvContent = result.csvContent;
                    }
                    
                    compareFilesData[file.name] = {
                        file: file,
                        headers: headers,
                        csvContent: csvContent,
                        isXlsx: ['xlsx', 'xls'].includes(ext),
                        isTxt: ext === 'txt'
                    };
                }
                
                displayCompareResults(headerRow);
                
            } catch (error) {
                console.error('Error comparing headers:', error);
                alert('Error processing files: ' + error.message);
            } finally {
                compareBtn.disabled = false;
                compareBtn.textContent = 'ðŸ”„ Compare Headers';
            }
        }
        
        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(new Error('Failed to read file'));
                reader.readAsText(file);
            });
        }
        
        async function parseXlsxForCompare(file, headerRow) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const csvContent = XLSX.utils.sheet_to_csv(firstSheet);
                        const headers = parseCompareHeaders(csvContent, headerRow, 'csv');
                        resolve({ headers, csvContent });
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = () => reject(new Error('Failed to read XLSX file'));
                reader.readAsArrayBuffer(file);
            });
        }
        
        function parseCompareHeaders(content, headerRow, fileType) {
            const lines = content.split('\n');
            
            if (lines.length < headerRow) {
                return [];
            }
            
            const headerLine = lines[headerRow - 1];
            
            if (!headerLine || !headerLine.trim()) {
                return [];
            }
            
            return parseCompareCSVLine(headerLine);
        }
        
        function parseCompareCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                    current += char;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current);
            return result;
        }
        
        function displayCompareResults(headerRow) {
            const resultsDiv = document.getElementById('compareResults');
            const summaryDiv = document.getElementById('compareSummary');
            const statusDiv = document.getElementById('compareStatusMessage');
            const fileResultsDiv = document.getElementById('compareFileResults');
            
            document.getElementById('compareHeaderRowUsed').textContent = `(using row ${headerRow} for headers in all files)`;
            
            const fileNames = Object.keys(compareFilesData);
            
            const headerGroups = {};
            fileNames.forEach(fileName => {
                const headers = compareFilesData[fileName].headers;
                const headerKey = JSON.stringify([...headers].sort());
                
                if (!headerGroups[headerKey]) {
                    headerGroups[headerKey] = {
                        headers: headers,
                        files: []
                    };
                }
                headerGroups[headerKey].files.push(fileName);
            });
            
            let referenceKey = null;
            let maxCount = 0;
            
            Object.keys(headerGroups).forEach(key => {
                if (headerGroups[key].files.length > maxCount) {
                    maxCount = headerGroups[key].files.length;
                    referenceKey = key;
                }
            });
            
            const referenceHeaders = headerGroups[referenceKey].headers;
            const referenceFiles = headerGroups[referenceKey].files;
            
            const fileResults = [];
            let matchCount = 0;
            let mismatchCount = 0;
            
            fileNames.forEach(fileName => {
                const fileHeaders = compareFilesData[fileName].headers;
                const isMatch = headersMatch(referenceHeaders, fileHeaders);
                
                if (isMatch) {
                    matchCount++;
                    fileResults.push({
                        fileName: fileName,
                        status: 'match',
                        headers: fileHeaders,
                        missingHeaders: [],
                        extraHeaders: [],
                        data: compareFilesData[fileName]
                    });
                } else {
                    mismatchCount++;
                    
                    const missingHeaders = referenceHeaders.filter(h => !fileHeaders.includes(h));
                    const extraHeaders = fileHeaders.filter(h => !referenceHeaders.includes(h));
                    
                    fileResults.push({
                        fileName: fileName,
                        status: 'mismatch',
                        headers: fileHeaders,
                        missingHeaders: missingHeaders,
                        extraHeaders: extraHeaders,
                        data: compareFilesData[fileName]
                    });
                }
            });
            
            fileResults.sort((a, b) => {
                if (a.status === 'mismatch' && b.status !== 'mismatch') return -1;
                if (a.status !== 'mismatch' && b.status === 'mismatch') return 1;
                return 0;
            });
            
            const uniquePatterns = Object.keys(headerGroups).length;
            
            summaryDiv.innerHTML = `
                <div class="compare-summary">
                    <div class="compare-summary-card">
                        <div class="compare-summary-number">${fileNames.length}</div>
                        <div class="compare-summary-label">Total Files</div>
                    </div>
                    <div class="compare-summary-card">
                        <div class="compare-summary-number">${referenceHeaders.length}</div>
                        <div class="compare-summary-label">Header Columns</div>
                    </div>
                    <div class="compare-summary-card success">
                        <div class="compare-summary-number">${matchCount}</div>
                        <div class="compare-summary-label">Matching Files</div>
                    </div>
                    <div class="compare-summary-card ${mismatchCount > 0 ? 'error' : ''}">
                        <div class="compare-summary-number">${mismatchCount}</div>
                        <div class="compare-summary-label">Outlier Files</div>
                    </div>
                </div>
            `;
            
            if (mismatchCount === 0) {
                statusDiv.innerHTML = `
                    <div class="compare-status-message success">
                        <span style="font-size: 1.5rem;">âœ…</span>
                        <span><strong>All files have matching headers!</strong> All ${fileNames.length} files have identical headers at row ${headerRow}.</span>
                    </div>
                `;
            } else if (uniquePatterns === fileNames.length) {
                statusDiv.innerHTML = `
                    <div class="compare-status-message error">
                        <span style="font-size: 1.5rem;">âš ï¸</span>
                        <span><strong>All files have different headers!</strong> No two files share the same header pattern. Using the first file as reference for comparison details.</span>
                    </div>
                `;
            } else {
                const outlierText = mismatchCount === 1 ? 'file does not match' : 'files do not match';
                statusDiv.innerHTML = `
                    <div class="compare-status-message error">
                        <span style="font-size: 1.5rem;">âš ï¸</span>
                        <span><strong>Header mismatch detected!</strong> ${mismatchCount} ${outlierText} the majority pattern (${matchCount} files share the same headers).</span>
                    </div>
                `;
            }
            
            fileResultsDiv.innerHTML = fileResults.map((result, index) => {
                let statusBadge = '';
                let statusClass = '';
                
                if (result.status === 'match') {
                    statusBadge = '<span class="compare-file-status-badge match">âœ“ Matches Majority</span>';
                    statusClass = 'match';
                } else {
                    statusBadge = '<span class="compare-file-status-badge mismatch">âš ï¸ Outlier</span>';
                    statusClass = 'mismatch';
                }
                
                let mismatchDetails = '';
                if (result.status === 'mismatch') {
                    let detailsContent = '';
                    
                    if (result.missingHeaders.length > 0) {
                        detailsContent += `
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #f87171;">Missing headers compared to majority (${result.missingHeaders.length}):</strong>
                                <div class="compare-headers-list">
                                    ${result.missingHeaders.map(h => `<span class="compare-header-tag missing">${escapeHtml(h)}</span>`).join('')}
                                </div>
                            </div>
                        `;
                    }
                    
                    if (result.extraHeaders.length > 0) {
                        detailsContent += `
                            <div>
                                <strong style="color: #fbbf24;">Extra headers not in majority (${result.extraHeaders.length}):</strong>
                                <div class="compare-headers-list">
                                    ${result.extraHeaders.map(h => `<span class="compare-header-tag extra">${escapeHtml(h)}</span>`).join('')}
                                </div>
                            </div>
                        `;
                    }
                    
                    mismatchDetails = `<div class="compare-mismatch-details"><h5>ðŸ” Differences from majority pattern:</h5>${detailsContent}</div>`;
                }
                
                let xlsxDownload = '';
                if (result.data.isXlsx && result.data.csvContent) {
                    const downloadFileName = result.fileName.replace(/\.(xlsx|xls)$/i, '_converted.csv');
                    xlsxDownload = `
                        <div class="compare-xlsx-download">
                            <span>ðŸ“„ This file was an XLSX file. Download as CSV:</span>
                            <button class="compare-xlsx-download-btn" onclick="downloadCompareCSV('${escapeHtml(downloadFileName)}', '${escapeHtml(result.fileName)}')">
                                ðŸ“¥ Download CSV
                            </button>
                        </div>
                    `;
                }
                
                return `
                    <div class="compare-file-result ${statusClass}">
                        <div class="compare-file-result-header" onclick="toggleCompareFileDetails(this)">
                            <div class="compare-file-result-title">
                                ${statusBadge}
                                <span>${escapeHtml(result.fileName)}</span>
                                <span style="color: #71717a; font-size: 0.85rem;">(${result.headers.length} columns)</span>
                            </div>
                            <span class="expand-icon">â–¼</span>
                        </div>
                        <div class="compare-file-result-body" id="compareFileBody-${index}">
                            <div>
                                <strong style="color: #a1a1aa;">Headers found:</strong>
                                <div class="compare-headers-list">
                                    ${result.headers.map(h => `<span class="compare-header-tag">${escapeHtml(h)}</span>`).join('')}
                                </div>
                            </div>
                            ${mismatchDetails}
                            ${xlsxDownload}
                        </div>
                    </div>
                `;
            }).join('');
            
            resultsDiv.classList.add('show');
            resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function headersMatch(arr1, arr2) {
            if (arr1.length !== arr2.length) return false;
            
            const sorted1 = [...arr1].sort();
            const sorted2 = [...arr2].sort();
            
            for (let i = 0; i < sorted1.length; i++) {
                if (sorted1[i] !== sorted2[i]) return false;
            }
            return true;
        }
        
        function toggleCompareFileDetails(headerElement) {
            const parent = headerElement.parentElement;
            const body = parent.querySelector('.compare-file-result-body');
            
            headerElement.classList.toggle('expanded');
            body.classList.toggle('show');
        }
        
        function downloadCompareCSV(filename, originalFileName) {
            const data = compareFilesData[originalFileName];
            if (!data || !data.csvContent) {
                alert('No CSV content available for download.');
                return;
            }
            
            const blob = new Blob([data.csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            } else {
                alert('Download not supported in this browser.');
            }
        }

        // ============================================
        // CHANNEL IDENTIFIER SECTION
        // ============================================

        let channelPdfDoc = null;
        let channelPdfScale = 1.0;
        let channelCsvData = null;
        let channelCsvHeaders = [];
        let channelCsvRawText = null;
        let selectedColumns = new Set();
        let comparisonChartInstance = null;
        let convertedCsvContent = null; // Store converted CSV content for download (TXT/XLSX files)
        let currentFileType = null; // Track current file type (csv, txt, xlsx)
        let currentFileName = null; // Track current file name
        const channelColors = [
            '#6366f1', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6',
            '#06b6d4', '#ec4899', '#84cc16', '#f97316', '#14b8a6',
            '#a855f7', '#22c55e', '#eab308', '#3b82f6', '#e11d48'
        ];

        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }

        function toggleChannelSection() {
            const header = document.getElementById('channelSectionHeader');
            const sectionBody = document.getElementById('channelSectionBody');
            const toggle = document.getElementById('channelSectionToggle');
            
            if (sectionBody.style.display === 'none') {
                sectionBody.style.display = 'block';
                header.classList.add('expanded');
                document.body.classList.add('channel-section-expanded');
                setTimeout(() => {
                    updateUploadRowVisibility();
                    if (comparisonChartInstance) {
                        comparisonChartInstance.resize();
                    }
                }, 100);
            } else {
                sectionBody.style.display = 'none';
                header.classList.remove('expanded');
                document.body.classList.remove('channel-section-expanded');
            }
        }

        // Helper function to detect file type from filename
        function detectFileType(fileName) {
            const lowerName = fileName.toLowerCase();
            if (lowerName.endsWith('.csv')) return 'csv';
            if (lowerName.endsWith('.txt')) return 'txt';
            if (lowerName.endsWith('.xlsx') || lowerName.endsWith('.xls')) return 'xlsx';
            return null;
        }

        function initializeChannelIdentifier() {
            const pdfInput = document.getElementById('channelPdfInput');
            const pdfUploadBox = document.getElementById('pdfUploadBox');
            const historicalFileInput = document.getElementById('channelHistoricalFileInput');
            const historicalFileUploadBox = document.getElementById('historicalFileUploadBox');

            if (pdfInput) {
                pdfInput.addEventListener('change', handlePdfUpload);
            }
            if (historicalFileInput) {
                historicalFileInput.addEventListener('change', handleHistoricalFileUpload);
            }

            if (pdfUploadBox) {
                pdfUploadBox.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    pdfUploadBox.classList.add('dragover');
                });
                pdfUploadBox.addEventListener('dragleave', () => {
                    pdfUploadBox.classList.remove('dragover');
                });
                pdfUploadBox.addEventListener('drop', (e) => {
                    e.preventDefault();
                    pdfUploadBox.classList.remove('dragover');
                    const files = e.dataTransfer.files;
                    if (files.length > 0 && files[0].type === 'application/pdf') {
                        handlePdfFile(files[0]);
                    }
                });
            }

            if (historicalFileUploadBox) {
                historicalFileUploadBox.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    historicalFileUploadBox.classList.add('dragover');
                });
                historicalFileUploadBox.addEventListener('dragleave', () => {
                    historicalFileUploadBox.classList.remove('dragover');
                });
                historicalFileUploadBox.addEventListener('drop', (e) => {
                    e.preventDefault();
                    historicalFileUploadBox.classList.remove('dragover');
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        const file = files[0];
                        const fileType = detectFileType(file.name);
                        if (fileType) {
                            handleDataFile(file, fileType);
                        } else {
                            alert('Please upload a CSV, TXT, or XLSX file.');
                        }
                    }
                });
            }
        }

        function handlePdfUpload(event) {
            const file = event.target.files[0];
            if (file && file.type === 'application/pdf') {
                handlePdfFile(file);
            }
        }

        async function handlePdfFile(file) {
            const pdfUploadBox = document.getElementById('pdfUploadBox');
            const pdfFileName = document.getElementById('pdfFileName');
            const pdfFileNameText = document.getElementById('pdfFileNameText');
            
            pdfUploadBox.classList.add('has-file');
            pdfFileName.style.display = 'flex';
            pdfFileNameText.textContent = file.name;
            
            showChannelLayout();
            
            document.getElementById('pdfViewerFileName').textContent = file.name;
            
            const arrayBuffer = await file.arrayBuffer();
            await renderPdf(arrayBuffer);
        }

        async function renderPdf(arrayBuffer) {
            const container = document.getElementById('pdfViewerContainer');
            container.innerHTML = '<div style="text-align: center; padding: 20px; color: #a1a1aa;">Loading PDF...</div>';
            
            try {
                channelPdfDoc = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                const numPages = channelPdfDoc.numPages;
                
                document.getElementById('pdfPageIndicator').textContent = `${numPages} page${numPages > 1 ? 's' : ''}`;
                
                container.innerHTML = '';
                
                for (let pageNum = 1; pageNum <= numPages; pageNum++) {
                    const page = await channelPdfDoc.getPage(pageNum);
                    const viewport = page.getViewport({ scale: channelPdfScale });
                    
                    const canvas = document.createElement('canvas');
                    canvas.className = 'pdf-page-canvas';
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;
                    
                    const context = canvas.getContext('2d');
                    
                    await page.render({
                        canvasContext: context,
                        viewport: viewport
                    }).promise;
                    
                    const pageIndicator = document.createElement('div');
                    pageIndicator.className = 'pdf-page-indicator';
                    pageIndicator.textContent = `Page ${pageNum} of ${numPages}`;
                    
                    const pageWrapper = document.createElement('div');
                    pageWrapper.style.marginBottom = '20px';
                    pageWrapper.appendChild(canvas);
                    pageWrapper.appendChild(pageIndicator);
                    
                    container.appendChild(pageWrapper);
                }
                
                updateZoomLevel();
            } catch (error) {
                console.error('Error rendering PDF:', error);
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #f87171;">Error loading PDF. Please try another file.</div>';
            }
        }

        async function rerenderPdf() {
            if (!channelPdfDoc) return;
            
            const container = document.getElementById('pdfViewerContainer');
            const numPages = channelPdfDoc.numPages;
            
            const scrollTop = container.scrollTop;
            const scrollHeight = container.scrollHeight;
            const clientHeight = container.clientHeight;
            const maxScroll = scrollHeight - clientHeight;
            const scrollPercentage = maxScroll > 0 ? scrollTop / maxScroll : 0;
            
            container.innerHTML = '';
            
            for (let pageNum = 1; pageNum <= numPages; pageNum++) {
                const page = await channelPdfDoc.getPage(pageNum);
                const viewport = page.getViewport({ scale: channelPdfScale });
                
                const canvas = document.createElement('canvas');
                canvas.className = 'pdf-page-canvas';
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                
                const context = canvas.getContext('2d');
                
                await page.render({
                    canvasContext: context,
                    viewport: viewport
                }).promise;
                
                const pageIndicator = document.createElement('div');
                pageIndicator.className = 'pdf-page-indicator';
                pageIndicator.textContent = `Page ${pageNum} of ${numPages}`;
                
                const pageWrapper = document.createElement('div');
                pageWrapper.style.marginBottom = '20px';
                pageWrapper.appendChild(canvas);
                pageWrapper.appendChild(pageIndicator);
                
                container.appendChild(pageWrapper);
            }
            
            const newScrollHeight = container.scrollHeight;
            const newClientHeight = container.clientHeight;
            const newMaxScroll = newScrollHeight - newClientHeight;
            container.scrollTop = scrollPercentage * newMaxScroll;
        }

        function zoomPdf(delta) {
            channelPdfScale = Math.max(0.25, Math.min(3.0, channelPdfScale + delta));
            updateZoomLevel();
            rerenderPdf();
        }

        function zoomPdfToValue(percentage) {
            channelPdfScale = Math.max(0.25, Math.min(3.0, percentage / 100));
            updateZoomLevel();
            rerenderPdf();
        }

        function fitPdfToWidth() {
            if (!channelPdfDoc) return;
            
            channelPdfDoc.getPage(1).then(page => {
                const container = document.getElementById('pdfViewerContainer');
                const containerWidth = container.clientWidth - 30;
                const viewport = page.getViewport({ scale: 1.0 });
                channelPdfScale = containerWidth / viewport.width;
                channelPdfScale = Math.max(0.25, Math.min(3.0, channelPdfScale));
                updateZoomLevel();
                rerenderPdf();
            });
        }

        function updateZoomLevel() {
            const percentage = Math.round(channelPdfScale * 100);
            document.getElementById('pdfZoomLevel').textContent = percentage + '%';
            
            const slider = document.getElementById('pdfZoomSlider');
            if (slider) {
                slider.value = percentage;
            }
        }

        function clearPdfFile() {
            channelPdfDoc = null;
            channelPdfScale = 1.0;
            
            const pdfUploadBox = document.getElementById('pdfUploadBox');
            const pdfFileName = document.getElementById('pdfFileName');
            const pdfInput = document.getElementById('channelPdfInput');
            
            pdfUploadBox.classList.remove('has-file');
            pdfFileName.style.display = 'none';
            pdfInput.value = '';
            
            document.getElementById('pdfViewerContainer').innerHTML = '';
            document.getElementById('pdfViewerFileName').textContent = '';
            document.getElementById('pdfPageIndicator').textContent = '';
            
            updateZoomLevel();
            
            checkLayoutVisibility();
        }

        // Helper function to detect delimiter in TXT files
        function detectDelimiter(line) {
            if (!line || line.trim().length === 0) {
                return ','; // Default to comma for empty lines
            }
            
            // Detect the most likely delimiter in the line
            const delimiters = [',', '\t', ';', '|', ' '];
            let bestDelimiter = ',';
            let maxColumns = 1;
            let bestScore = 0;
            
            delimiters.forEach(delimiter => {
                const columns = line.split(delimiter);
                const score = columns.length;
                
                // Prefer delimiters that create more columns and have consistent column lengths
                if (score > maxColumns) {
                    maxColumns = score;
                    bestDelimiter = delimiter;
                    bestScore = score;
                } else if (score === maxColumns) {
                    // If same number of columns, prefer non-space delimiters
                    if (delimiter !== ' ' && bestDelimiter === ' ') {
                        bestDelimiter = delimiter;
                    }
                }
            });
            
            // Validate that we have a reasonable number of columns
            if (maxColumns < 2) {
                console.warn('Warning: Detected delimiter resulted in very few columns, falling back to comma');
                return ',';
            }
            
            console.log(`Detected delimiter: "${bestDelimiter}" with ${maxColumns} columns`);
            return bestDelimiter;
        }

        // Convert TXT file to CSV format
        function convertTxtToCsv(txtContent, fileType) {
            if (fileType !== 'txt') {
                return txtContent; // Return as-is for non-TXT files
            }
            
            if (!txtContent || txtContent.trim().length === 0) {
                throw new Error('TXT file is empty or contains no valid content');
            }
            
            const lines = txtContent.split('\n');
            const convertedLines = [];
            
            let hasValidLines = false;
            
            lines.forEach((line, lineIndex) => {
                if (line.trim()) {
                    hasValidLines = true;
                    const delimiter = detectDelimiter(line);
                    let convertedLine = '';
                    
                    // Split by detected delimiter and convert to CSV format
                    const columns = line.split(delimiter);
                    columns.forEach((col, index) => {
                        const trimmedCol = col.trim();
                        
                        // Add quotes if column contains comma, quotes, or newlines
                        if (trimmedCol.includes(',') || trimmedCol.includes('"') || trimmedCol.includes('\n')) {
                            // Escape existing quotes and wrap in quotes
                            const escapedCol = trimmedCol.replace(/"/g, '""');
                            convertedLine += `"${escapedCol}"`;
                        } else {
                            convertedLine += trimmedCol;
                        }
                        
                        // Add comma separator (except for last column)
                        if (index < columns.length - 1) {
                            convertedLine += ',';
                        }
                    });
                    
                    convertedLines.push(convertedLine);
                }
            });
            
            if (!hasValidLines) {
                throw new Error('TXT file contains no non-empty lines');
            }
            
            return convertedLines.join('\n');
        }

        function handleHistoricalFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const fileType = detectFileType(file.name);
                if (fileType) {
                    handleDataFile(file, fileType);
                } else {
                    alert('Please upload a CSV, TXT, or XLSX file.');
                }
            }
        }

        function handleDataFile(file, fileType) {
            // Update the historical file upload box
            const historicalFileUploadBox = document.getElementById('historicalFileUploadBox');
            const historicalFileName = document.getElementById('historicalFileName');
            const historicalFileNameText = document.getElementById('historicalFileNameText');
            
            // Set the upload box to show file
            historicalFileUploadBox.classList.add('has-file');
            historicalFileName.style.display = 'flex';
            historicalFileNameText.textContent = file.name;
            
            showChannelLayout();
            
            document.getElementById('csvBadgeFileName').textContent = file.name;
            
            // Store file info
            currentFileType = fileType;
            currentFileName = file.name;
            
            // Handle XLSX files (binary format)
            if (fileType === 'xlsx') {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        // Get the first sheet
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        
                        // Convert to CSV
                        const csvContent = XLSX.utils.sheet_to_csv(worksheet);
                        
                        // Store converted content for download
                        convertedCsvContent = csvContent;
                        
                        console.log('XLSX file converted to CSV format for processing');
                        parseCsvData(csvContent);
                        updateDownloadButton();
                    } catch (error) {
                        console.error('Error processing XLSX file:', error);
                        alert('Error processing XLSX file: ' + error.message);
                        convertedCsvContent = null;
                        updateDownloadButton();
                    }
                };
                reader.readAsArrayBuffer(file);
                return;
            }
            
            // Handle CSV and TXT files (text format)
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    let fileContent = e.target.result;
                    
                    // Convert TXT to CSV format if needed
                    if (fileType === 'txt') {
                        try {
                            fileContent = convertTxtToCsv(fileContent, fileType);
                            // Store converted content for download
                            convertedCsvContent = fileContent;
                            console.log('TXT file converted to CSV format for processing');
                        } catch (conversionError) {
                            console.error('Error converting TXT file:', conversionError);
                            alert(`Error converting TXT file: ${conversionError.message}`);
                            convertedCsvContent = null;
                            updateDownloadButton();
                            return;
                        }
                    } else {
                        // CSV files - no conversion needed
                        convertedCsvContent = null;
                    }
                    
                    parseCsvData(fileContent);
                    updateDownloadButton();
                } catch (error) {
                    console.error('Error processing file:', error);
                    alert('Error processing file: ' + error.message);
                    convertedCsvContent = null;
                    updateDownloadButton();
                }
            };
            reader.readAsText(file);
        }

        function parseCsvData(csvText, headerRowNum = null) {
            channelCsvRawText = csvText;
            
            const statusEl = document.getElementById('headerRowStatus');
            
            if (headerRowNum === null) {
                headerRowNum = parseInt(document.getElementById('channelHeaderRow').value) || 1;
            }
            
            const lines = csvText.trim().split('\n');
            const headerIndex = headerRowNum - 1;
            
            if (lines.length < headerRowNum + 1) {
                statusEl.textContent = `Error: Need at least ${headerRowNum + 1} rows`;
                statusEl.className = 'header-row-status error';
                return;
            }
            
            if (headerIndex < 0 || headerIndex >= lines.length) {
                statusEl.textContent = 'Error: Invalid row number';
                statusEl.className = 'header-row-status error';
                return;
            }
            
            channelCsvHeaders = parseCSVLine(lines[headerIndex]);
            
            channelCsvData = [];
            for (let i = headerIndex + 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                if (values.length === channelCsvHeaders.length) {
                    const row = {};
                    channelCsvHeaders.forEach((header, index) => {
                        row[header] = values[index];
                    });
                    channelCsvData.push(row);
                }
            }
            
            const rowsToCheck = Math.min(20, channelCsvData.length);
            const numericHeaders = channelCsvHeaders.filter(header => {
                for (let i = 0; i < rowsToCheck; i++) {
                    const value = channelCsvData[i][header];
                    if (value !== undefined && value !== '' && !isNaN(parseFloat(value))) {
                        return true;
                    }
                }
                return false;
            });
            const numericCount = numericHeaders.length;
            
            let usableCount = 0;
            let zeroOrNegativeCount = 0;
            
            numericHeaders.forEach(header => {
                const avg = calculateChannelColumnAverage(header);
                if (avg !== null) {
                    if (avg > 0) {
                        usableCount++;
                    } else {
                        zeroOrNegativeCount++;
                    }
                }
            });
            
            statusEl.innerHTML = `${channelCsvHeaders.length} cols, ${channelCsvData.length} rows | <span style="color: #10b981;">${usableCount} >0</span> | <span style="color: #f59e0b;">${zeroOrNegativeCount} â‰¤0</span>`;
            statusEl.className = 'header-row-status';
            
            selectedColumns.clear();
            
            populateColumnSelector();
            
            document.getElementById('comparisonChartPlaceholder').style.display = 'flex';
            const scalePop = document.getElementById('comparisonChartScalePopup');
            if (scalePop) scalePop.classList.remove('show');
        }

        function reprocessCsvWithNewHeaderRow() {
            if (!channelCsvRawText) {
                alert('Please upload a CSV file first.');
                return;
            }
            
            const headerRowNum = parseInt(document.getElementById('channelHeaderRow').value) || 1;
            parseCsvData(channelCsvRawText, headerRowNum);
            
            if (comparisonChartInstance) {
                comparisonChartInstance.destroy();
                comparisonChartInstance = null;
            }
            document.getElementById('comparisonChartPlaceholder').style.display = 'flex';
            document.getElementById('comparisonChart').style.display = 'none';
            const compScalePopup = document.getElementById('comparisonChartScalePopup');
            if (compScalePopup) compScalePopup.classList.remove('show');
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            
            return result;
        }

        function calculateChannelColumnAverage(header) {
            if (!channelCsvData || channelCsvData.length === 0) return null;
            
            let sum = 0;
            let count = 0;
            
            channelCsvData.forEach(row => {
                const value = parseFloat(row[header]);
                if (!isNaN(value)) {
                    sum += value;
                    count++;
                }
            });
            
            return count > 0 ? sum / count : null;
        }

        function formatAverage(value) {
            if (value === null || value === undefined) return 'N/A';
            
            const absValue = Math.abs(value);
            
            if (absValue === 0) return '0';
            if (absValue >= 1000000) return value.toExponential(2);
            if (absValue >= 1000) return value.toLocaleString(undefined, { maximumFractionDigits: 1 });
            if (absValue >= 1) return value.toFixed(2);
            if (absValue >= 0.01) return value.toFixed(3);
            return value.toExponential(2);
        }

        function populateColumnSelector() {
            const container = document.getElementById('columnCheckboxes');
            container.innerHTML = '';
            
            const searchInput = document.getElementById('columnSearchInput');
            if (searchInput) {
                searchInput.value = '';
                const clearBtn = document.getElementById('columnSearchClear');
                if (clearBtn) clearBtn.classList.remove('visible');
                const resultsDiv = document.getElementById('columnSearchResults');
                if (resultsDiv) resultsDiv.textContent = '';
            }
            const avgMin = document.getElementById('columnAvgMin');
            const avgMax = document.getElementById('columnAvgMax');
            const avgClear = document.getElementById('columnAvgClear');
            if (avgMin) avgMin.value = '';
            if (avgMax) avgMax.value = '';
            if (avgClear) avgClear.classList.remove('visible');
            
            if (channelCsvHeaders.length === 0) {
                container.innerHTML = '<div class="no-columns-message">Upload a CSV, TXT, or XLSX file to see available columns</div>';
                return;
            }
            
            if (channelCsvData.length === 0) {
                container.innerHTML = '<div class="no-columns-message">No data rows found after header row</div>';
                return;
            }
            
            const numericStatus = {};
            const rowsToCheck = Math.min(20, channelCsvData.length);
            
            channelCsvHeaders.forEach(header => {
                numericStatus[header] = false;
                for (let i = 0; i < rowsToCheck; i++) {
                    const value = channelCsvData[i][header];
                    if (value !== undefined && value !== '' && !isNaN(parseFloat(value))) {
                        numericStatus[header] = true;
                        break;
                    }
                }
            });
            
            const columnData = [];
            channelCsvHeaders.forEach((header, index) => {
                const isNumeric = numericStatus[header];
                const average = isNumeric ? calculateChannelColumnAverage(header) : null;
                columnData.push({
                    header,
                    isNumeric,
                    average,
                    originalIndex: index
                });
            });
            
            const sortedColumns = [...columnData].sort((a, b) => {
                if (a.isNumeric && !b.isNumeric) return -1;
                if (!a.isNumeric && b.isNumeric) return 1;
                return 0;
            });
            
            const nonZeroColumns = [];
            const zeroOrNegativeColumns = [];
            
            sortedColumns.forEach(col => {
                if (col.isNumeric && col.average !== null && parseFloat(col.average) <= 0) {
                    zeroOrNegativeColumns.push(col);
                } else {
                    nonZeroColumns.push(col);
                }
            });
            
            const createColumnItem = (col, colorIndex) => {
                const color = col.isNumeric ? channelColors[colorIndex % channelColors.length] : '#4a4a5a';
                const avgDisplay = col.isNumeric ? formatAverage(col.average) : '';
                
                const item = document.createElement('label');
                item.className = 'column-checkbox-item' + (col.isNumeric ? '' : ' non-numeric');
                if (col.isNumeric && col.average != null) {
                    item.setAttribute('data-average', String(col.average));
                } else {
                    item.setAttribute('data-average', '');
                }
                item.innerHTML = `
                    <input type="checkbox" value="${col.header}" onchange="toggleColumn('${col.header.replace(/'/g, "\\'")}', this.checked)" ${col.isNumeric ? '' : 'disabled'}>
                    <span class="column-color-dot" style="background-color: ${color}"></span>
                    <span class="column-checkbox-label" title="${col.header}${col.isNumeric ? '' : ' (non-numeric)'}">${col.header}</span>
                    ${col.isNumeric ? `<span class="column-average" title="Average: ${avgDisplay}">avg: ${avgDisplay}</span>` : '<span class="non-numeric-badge">text</span>'}
                `;
                return item;
            };
            
            nonZeroColumns.forEach((col, index) => {
                container.appendChild(createColumnItem(col, index));
            });
            
            if (zeroOrNegativeColumns.length > 0) {
                const zeroSection = document.createElement('div');
                zeroSection.className = 'zero-columns-section';
                zeroSection.innerHTML = `
                    <div class="zero-columns-header" onclick="toggleZeroColumnsSection(this)">
                        <span class="zero-columns-title">
                            Values â‰¤ 0
                            <span class="zero-columns-count">${zeroOrNegativeColumns.length}</span>
                        </span>
                        <span class="zero-columns-toggle">â–¼</span>
                    </div>
                    <div class="zero-columns-body">
                        <div class="zero-columns-hint">These columns have an average value of zero or less</div>
                    </div>
                `;
                
                const zeroBody = zeroSection.querySelector('.zero-columns-body');
                zeroOrNegativeColumns.forEach((col, index) => {
                    zeroBody.appendChild(createColumnItem(col, nonZeroColumns.length + index));
                });
                
                container.appendChild(zeroSection);
            }
            
            const numericCountTotal = Object.values(numericStatus).filter(v => v).length;
            
            if (numericCountTotal === 0) {
                container.innerHTML = '<div class="no-columns-message">No numeric columns found. Check if header row is correct.</div>';
            }
        }
        
        function toggleZeroColumnsSection(headerElement) {
            const body = headerElement.nextElementSibling;
            const isExpanded = headerElement.classList.contains('expanded');
            
            if (isExpanded) {
                headerElement.classList.remove('expanded');
                body.classList.remove('expanded');
            } else {
                headerElement.classList.add('expanded');
                body.classList.add('expanded');
            }
        }

        function toggleColumn(columnName, isSelected) {
            if (isSelected) {
                selectedColumns.add(columnName);
            } else {
                selectedColumns.delete(columnName);
            }
            
            const checkboxes = document.querySelectorAll('#columnCheckboxes .column-checkbox-item');
            checkboxes.forEach(item => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                if (checkbox.value === columnName) {
                    if (isSelected) {
                        item.classList.add('selected');
                    } else {
                        item.classList.remove('selected');
                    }
                }
            });
            
            updateComparisonChart();
        }

        function selectAllColumns() {
            const checkboxes = document.querySelectorAll('#columnCheckboxes input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                const item = checkbox.closest('.column-checkbox-item');
                if (!item.classList.contains('hidden') && !checkbox.disabled) {
                    checkbox.checked = true;
                    selectedColumns.add(checkbox.value);
                    item.classList.add('selected');
                }
            });
            updateComparisonChart();
        }

        function clearAllColumns() {
            const checkboxes = document.querySelectorAll('#columnCheckboxes input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                const item = checkbox.closest('.column-checkbox-item');
                if (!item.classList.contains('hidden')) {
                    checkbox.checked = false;
                    item.classList.remove('selected');
                    selectedColumns.delete(checkbox.value);
                }
            });
            updateComparisonChart();
        }

        function applyColumnFilters() {
            const searchInput = document.getElementById('columnSearchInput');
            const normalizedSearch = (searchInput && searchInput.value) ? searchInput.value.toLowerCase().trim() : '';
            const minInput = document.getElementById('columnAvgMin');
            const maxInput = document.getElementById('columnAvgMax');
            const minStr = minInput ? minInput.value.trim() : '';
            const maxStr = maxInput ? maxInput.value.trim() : '';
            const avgFilterActive = minStr !== '' || maxStr !== '';
            const minVal = minStr === '' ? -Infinity : parseFloat(minStr);
            const maxVal = maxStr === '' ? Infinity : parseFloat(maxStr);
            const minValid = minStr === '' || !isNaN(minVal);
            const maxValid = maxStr === '' || !isNaN(maxVal);

            const items = document.querySelectorAll('#columnCheckboxes .column-checkbox-item');
            const clearBtn = document.getElementById('columnSearchClear');
            const avgClearBtn = document.getElementById('columnAvgClear');
            const resultsDiv = document.getElementById('columnSearchResults');
            const zeroSection = document.querySelector('#columnCheckboxes .zero-columns-section');

            if (clearBtn) {
                clearBtn.classList.toggle('visible', !!normalizedSearch);
            }
            if (avgClearBtn) {
                avgClearBtn.classList.toggle('visible', avgFilterActive);
            }

            let visibleCount = 0;
            let totalCount = items.length;
            let zeroSectionVisibleCount = 0;

            items.forEach(item => {
                const label = item.querySelector('.column-checkbox-label');
                const columnName = label ? label.textContent.toLowerCase() : '';
                const nameMatch = !normalizedSearch || columnName.includes(normalizedSearch);

                const dataAvg = item.getAttribute('data-average') || '';
                let avgMatch = true;
                if (avgFilterActive && minValid && maxValid) {
                    if (dataAvg === '') {
                        avgMatch = false;
                    } else {
                        const avg = parseFloat(dataAvg);
                        avgMatch = !isNaN(avg) && avg >= minVal && avg <= maxVal;
                    }
                }

                const show = nameMatch && avgMatch;
                if (show) {
                    item.classList.remove('hidden');
                    visibleCount++;
                    if (item.closest('.zero-columns-section')) zeroSectionVisibleCount++;
                } else {
                    item.classList.add('hidden');
                }
            });

            if (zeroSection) {
                const zeroHeader = zeroSection.querySelector('.zero-columns-header');
                const zeroBody = zeroSection.querySelector('.zero-columns-body');
                if (normalizedSearch || avgFilterActive) {
                    if (zeroSectionVisibleCount > 0) {
                        zeroSection.style.display = '';
                        zeroHeader.classList.add('expanded');
                        zeroBody.classList.add('expanded');
                    } else {
                        zeroSection.style.display = 'none';
                    }
                } else {
                    zeroSection.style.display = '';
                    zeroHeader.classList.remove('expanded');
                    zeroBody.classList.remove('expanded');
                }
            }

            if (resultsDiv) {
                if ((normalizedSearch || avgFilterActive) && totalCount > 0) {
                    resultsDiv.textContent = `Showing ${visibleCount} of ${totalCount} columns`;
                } else {
                    resultsDiv.textContent = '';
                }
            }
        }

        function filterColumns(searchTerm) {
            const searchInput = document.getElementById('columnSearchInput');
            if (searchInput) searchInput.value = searchTerm || '';
            applyColumnFilters();
        }

        function clearColumnSearch() {
            const searchInput = document.getElementById('columnSearchInput');
            if (searchInput) searchInput.value = '';
            applyColumnFilters();
            searchInput.focus();
        }

        function clearAvgFilter() {
            const minInput = document.getElementById('columnAvgMin');
            const maxInput = document.getElementById('columnAvgMax');
            if (minInput) minInput.value = '';
            if (maxInput) maxInput.value = '';
            applyColumnFilters();
        }

        function updateComparisonChart() {
            const placeholder = document.getElementById('comparisonChartPlaceholder');
            const canvas = document.getElementById('comparisonChart');
            const legendContainer = document.getElementById('chartLegendContainer');
            const scalePopup = document.getElementById('comparisonChartScalePopup');
            
            if (selectedColumns.size === 0 || !channelCsvData || channelCsvData.length === 0) {
                placeholder.style.display = 'flex';
                canvas.style.display = 'none';
                legendContainer.style.display = 'none';
                if (scalePopup) {
                    scalePopup.classList.remove('show');
                    document.removeEventListener('click', closeComparisonChartScalePopupOnClickOutside);
                }
                
                if (comparisonChartInstance) {
                    comparisonChartInstance.destroy();
                    comparisonChartInstance = null;
                }
                return;
            }
            
            placeholder.style.display = 'none';
            canvas.style.display = 'block';
            legendContainer.style.display = 'flex';
            if (scalePopup) {
                scalePopup.classList.remove('show');
                document.removeEventListener('click', closeComparisonChartScalePopupOnClickOutside);
            }
            
            const labels = channelCsvData.map((_, index) => index + 1);
            const datasets = [];
            const legendItems = [];
            
            let colorIndex = 0;
            channelCsvHeaders.forEach(header => {
                if (selectedColumns.has(header)) {
                    const color = channelColors[colorIndex % channelColors.length];
                    const average = calculateChannelColumnAverage(header);
                    
                    datasets.push({
                        label: header,
                        data: channelCsvData.map(row => parseFloat(row[header]) || 0),
                        borderColor: color,
                        backgroundColor: color + '20',
                        borderWidth: 1.5,
                        pointRadius: 0,
                        tension: 0.1,
                        fill: false
                    });
                    
                    legendItems.push({
                        name: header,
                        color: color,
                        average: average
                    });
                }
                colorIndex++;
            });
            
            legendContainer.innerHTML = legendItems.map(item => `
                <div class="chart-legend-item">
                    <span class="chart-legend-color" style="background-color: ${item.color}"></span>
                    <span class="chart-legend-name" title="${item.name}">${item.name}</span>
                    <span class="chart-legend-avg">avg: ${formatAverage(item.average)}</span>
                </div>
            `).join('');
            
            if (comparisonChartInstance) {
                comparisonChartInstance.destroy();
            }
            
            const ctx = canvas.getContext('2d');
            comparisonChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: { top: 10, right: 15, bottom: 25, left: 10 }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: '#252536',
                            titleColor: '#e4e4e7',
                            bodyColor: '#a1a1aa',
                            borderColor: '#3d3d5c',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Time (seconds)',
                                color: '#a1a1aa'
                            },
                            ticks: {
                                color: '#71717a',
                                maxTicksLimit: 20
                            },
                            grid: {
                                color: '#2d2d3d'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Value',
                                color: '#a1a1aa'
                            },
                            min: undefined,
                            max: undefined,
                            ticks: {
                                color: '#71717a'
                            },
                            grid: {
                                color: '#2d2d3d'
                            }
                        }
                    }
                }
            });

            const compMinInput = document.getElementById('comparisonChartYMin');
            const compMaxInput = document.getElementById('comparisonChartYMax');
            if (compMinInput) compMinInput.value = '';
            if (compMaxInput) compMaxInput.value = '';

            function handleComparisonChartCanvasClick(e) {
                if (!comparisonChartInstance) return;
                const yScale = comparisonChartInstance.scales.y;
                if (!yScale) return;
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                if (x >= yScale.left - 8 && x <= yScale.right + 8) {
                    const popup = document.getElementById('comparisonChartScalePopup');
                    if (popup) {
                        popup.classList.add('show');
                        const inp = document.getElementById('comparisonChartYMin');
                        if (inp) inp.focus();
                        setTimeout(function() {
                            document.addEventListener('click', closeComparisonChartScalePopupOnClickOutside);
                        }, 0);
                    }
                }
            }
            function handleComparisonChartCanvasMouseMove(e) {
                if (!comparisonChartInstance) return;
                const yScale = comparisonChartInstance.scales.y;
                if (!yScale) return;
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const onAxis = x >= yScale.left - 8 && x <= yScale.right + 8;
                canvas.style.cursor = onAxis ? 'pointer' : 'default';
            }
            canvas.removeEventListener('click', handleComparisonChartCanvasClick);
            canvas.removeEventListener('mousemove', handleComparisonChartCanvasMouseMove);
            canvas.addEventListener('click', handleComparisonChartCanvasClick);
            canvas.addEventListener('mousemove', handleComparisonChartCanvasMouseMove);

            if (compMinInput) compMinInput.onkeydown = function(e) { if (e.key === 'Enter') applyComparisonChartAxisScale(); };
            if (compMaxInput) compMaxInput.onkeydown = function(e) { if (e.key === 'Enter') applyComparisonChartAxisScale(); };
        }

        function applyComparisonChartAxisScale() {
            if (!comparisonChartInstance) return;
            const minInput = document.getElementById('comparisonChartYMin');
            const maxInput = document.getElementById('comparisonChartYMax');
            const minVal = minInput ? minInput.value.trim() : '';
            const maxVal = maxInput ? maxInput.value.trim() : '';
            const scale = comparisonChartInstance.options.scales.y;
            scale.min = minVal === '' ? undefined : parseFloat(minVal);
            scale.max = maxVal === '' ? undefined : parseFloat(maxVal);
            if (minVal !== '' && isNaN(scale.min)) return;
            if (maxVal !== '' && isNaN(scale.max)) return;
            comparisonChartInstance.update();
        }

        function resetComparisonChartAxisScale() {
            if (!comparisonChartInstance) return;
            const minInput = document.getElementById('comparisonChartYMin');
            const maxInput = document.getElementById('comparisonChartYMax');
            if (minInput) minInput.value = '';
            if (maxInput) maxInput.value = '';
            comparisonChartInstance.options.scales.y.min = undefined;
            comparisonChartInstance.options.scales.y.max = undefined;
            comparisonChartInstance.update();
        }

        function closeComparisonChartScalePopup() {
            const popup = document.getElementById('comparisonChartScalePopup');
            if (popup) popup.classList.remove('show');
            document.removeEventListener('click', closeComparisonChartScalePopupOnClickOutside);
        }

        function closeComparisonChartScalePopupOnClickOutside(e) {
            const popup = document.getElementById('comparisonChartScalePopup');
            if (popup && popup.classList.contains('show') && !popup.contains(e.target)) {
                popup.classList.remove('show');
                document.removeEventListener('click', closeComparisonChartScalePopupOnClickOutside);
            }
        }

        function clearCsvFile() {
            channelCsvData = null;
            channelCsvHeaders = [];
            channelCsvRawText = null;
            selectedColumns.clear();
            
            const historicalFileUploadBox = document.getElementById('historicalFileUploadBox');
            const historicalFileName = document.getElementById('historicalFileName');
            const historicalFileInput = document.getElementById('channelHistoricalFileInput');
            
            if (historicalFileUploadBox) {
                historicalFileUploadBox.classList.remove('has-file');
            }
            if (historicalFileName) {
                historicalFileName.style.display = 'none';
            }
            if (historicalFileInput) {
                historicalFileInput.value = '';
            }
            
            document.getElementById('channelHeaderRow').value = 1;
            
            document.getElementById('columnSearchInput').value = '';
            document.getElementById('columnSearchClear').classList.remove('visible');
            document.getElementById('columnSearchResults').textContent = '';
            
            document.getElementById('csvBadgeFileName').textContent = 'No file loaded';
            document.getElementById('columnCheckboxes').innerHTML = '<div class="no-columns-message">Upload a CSV, TXT, or XLSX file to see available columns</div>';
            
            if (comparisonChartInstance) {
                comparisonChartInstance.destroy();
                comparisonChartInstance = null;
            }
            
            document.getElementById('comparisonChartPlaceholder').style.display = 'flex';
            document.getElementById('comparisonChart').style.display = 'none';
            document.getElementById('chartLegendContainer').style.display = 'none';
            const comparisonScalePopup = document.getElementById('comparisonChartScalePopup');
            if (comparisonScalePopup) {
                comparisonScalePopup.classList.remove('show');
                document.removeEventListener('click', closeComparisonChartScalePopupOnClickOutside);
            }
            
            checkLayoutVisibility();
            
            // Clear download button
            convertedCsvContent = null;
            currentFileType = null;
            currentFileName = null;
            updateDownloadButton();
        }

        function updateDownloadButton() {
            const downloadBtn = document.getElementById('downloadCsvBtn');
            if (downloadBtn) {
                if (convertedCsvContent && (currentFileType === 'txt' || currentFileType === 'xlsx')) {
                    downloadBtn.style.display = 'inline-block';
                } else {
                    downloadBtn.style.display = 'none';
                }
            }
        }

        function downloadConvertedCsv() {
            if (!convertedCsvContent) {
                alert('No converted content available for download.');
                return;
            }
            
            // Generate filename based on original file
            let filename = 'converted.csv';
            if (currentFileName) {
                if (currentFileType === 'txt') {
                    filename = currentFileName.replace(/\.txt$/i, '_converted.csv');
                } else if (currentFileType === 'xlsx') {
                    filename = currentFileName.replace(/\.(xlsx|xls)$/i, '_converted.csv');
                }
            }
            
            // Create a blob with the CSV content
            const blob = new Blob([convertedCsvContent], { type: 'text/csv;charset=utf-8;' });
            
            // Create download link
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            } else {
                // Fallback for older browsers
                window.open('data:text/csv;charset=utf-8,' + encodeURIComponent(convertedCsvContent));
            }
        }

        function showChannelLayout() {
            const layout = document.getElementById('channelIdentifierLayout');
            layout.style.display = 'grid';
            updateUploadRowVisibility();
        }

        function checkLayoutVisibility() {
            const hasPdf = channelPdfDoc !== null;
            const hasCsv = channelCsvData !== null;
            
            if (!hasPdf && !hasCsv) {
                document.getElementById('channelIdentifierLayout').style.display = 'none';
            }
            updateUploadRowVisibility();
        }

        function updateUploadRowVisibility() {
            const uploadRow = document.querySelector('.channel-upload-row');
            
            if (uploadRow) {
                const hasPdf = channelPdfDoc !== null;
                const hasCsv = channelCsvData !== null;
                
                if (hasPdf && hasCsv) {
                    uploadRow.classList.add('hidden-in-fullwidth');
                } else {
                    uploadRow.classList.remove('hidden-in-fullwidth');
                }
            }
        }

        // ============================================
        // PANEL RESIZER FUNCTIONALITY
        // ============================================
        
        function initializePanelResizer() {
            const resizer = document.getElementById('panelResizer');
            const layout = document.getElementById('channelIdentifierLayout');
            const pdfPanel = layout ? layout.querySelector('.pdf-panel') : null;
            const chartPanel = layout ? layout.querySelector('.chart-panel') : null;
            
            if (!resizer || !layout || !pdfPanel || !chartPanel) {
                return;
            }
            
            let isResizing = false;
            let startX = 0;
            let startWidth = 0;
            
            const savedWidth = localStorage.getItem('pdfPanelWidth');
            if (savedWidth) {
                pdfPanel.style.width = savedWidth;
            }
            
            resizer.addEventListener('mousedown', function(e) {
                isResizing = true;
                startX = e.clientX;
                startWidth = pdfPanel.getBoundingClientRect().width;
                
                resizer.classList.add('dragging');
                document.body.classList.add('resizing');
                
                e.preventDefault();
            });
            
            document.addEventListener('mousemove', function(e) {
                if (!isResizing) return;
                
                const layoutRect = layout.getBoundingClientRect();
                const deltaX = e.clientX - startX;
                let newWidth = startWidth + deltaX;
                
                const minWidth = 200;
                const maxWidth = layoutRect.width - 220;
                
                newWidth = Math.max(minWidth, Math.min(maxWidth, newWidth));
                
                pdfPanel.style.width = newWidth + 'px';
                
                window.dispatchEvent(new Event('resize'));
            });
            
            document.addEventListener('mouseup', function(e) {
                if (!isResizing) return;
                
                isResizing = false;
                resizer.classList.remove('dragging');
                document.body.classList.remove('resizing');
                
                localStorage.setItem('pdfPanelWidth', pdfPanel.style.width);
            });
            
            resizer.addEventListener('dblclick', function() {
                pdfPanel.style.width = '50%';
                localStorage.removeItem('pdfPanelWidth');
                window.dispatchEvent(new Event('resize'));
            });
        }

        // ============================================
        // COLUMN SELECTOR RESIZER FUNCTIONALITY
        // ============================================
        
        function initializeColumnResizer() {
            const resizer = document.getElementById('columnResizer');
            const columnSelector = document.getElementById('columnSelectorContainer');
            const chartPanel = document.querySelector('.chart-panel');
            
            if (!resizer || !columnSelector || !chartPanel) {
                return;
            }
            
            let isResizing = false;
            let startY = 0;
            let startHeight = 0;
            
            const savedHeight = localStorage.getItem('columnSelectorHeight');
            if (savedHeight) {
                columnSelector.style.height = savedHeight;
            }
            
            resizer.addEventListener('mousedown', function(e) {
                isResizing = true;
                startY = e.clientY;
                startHeight = columnSelector.getBoundingClientRect().height;
                
                resizer.classList.add('dragging');
                document.body.classList.add('resizing-vertical');
                
                e.preventDefault();
            });
            
            document.addEventListener('mousemove', function(e) {
                if (!isResizing) return;
                
                const deltaY = e.clientY - startY;
                let newHeight = startHeight + deltaY;
                
                const minHeight = 80;
                const maxHeight = chartPanel.clientHeight - 200;
                
                newHeight = Math.max(minHeight, Math.min(maxHeight, newHeight));
                
                columnSelector.style.height = newHeight + 'px';
                
                window.dispatchEvent(new Event('resize'));
            });
            
            document.addEventListener('mouseup', function(e) {
                if (!isResizing) return;
                
                isResizing = false;
                resizer.classList.remove('dragging');
                document.body.classList.remove('resizing-vertical');
                
                localStorage.setItem('columnSelectorHeight', columnSelector.style.height);
            });
            
            resizer.addEventListener('dblclick', function() {
                columnSelector.style.height = '200px';
                localStorage.removeItem('columnSelectorHeight');
                window.dispatchEvent(new Event('resize'));
            });
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeHeaderComparison();
            initializeChannelIdentifier();
            initializePanelResizer();
            initializeColumnResizer();
            
            window.addEventListener('resize', function() {
                if (document.body.classList.contains('channel-section-expanded') && comparisonChartInstance) {
                    comparisonChartInstance.resize();
                }
            });
        });
    </script>
</body>
</html>
